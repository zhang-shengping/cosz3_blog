---
title: Kolla 部署 F5 Lbassv2 Agent 集成
categories:
- Kolla
tags:
- F5
- self-note
---

![front](https://github.com/zhang-shengping/cosz3_blog/raw/gh-pages/images/f5-kolla/f5-kolla-0.jpg)

# F5 agent Kolla 自定义安装/启动

### 环境创建和准备工作

#### 安装 virutalenv，ansible

```bash
sudo yum install python-virtualenv
virtualenv /path/to/virtualenv
source /path/to/virtualenv/bin/activate
pip install -U pip
pip install ansible
```

#### 下载安装 Kolla-ansible, Kolla

```bash
# 源码方式下载
git clone https://github.com/openstack/kolla
git clone https://github.com/openstack/kolla-ansible

# 切换到对应分支
git checkout <version>
git checkout <version>

# 以上两部可以省略为
git clone https://github.com/openstack/kolla -b <version>
git clone https://github.com/openstack/kolla-ansible -b <version>

# 安装 kolla 和 kolla-ansible
pip install ./kolla
pip install ./kolla-ansible

# 创建 kolla 和 kolla-ansible 配置文件目录
sudo mkdir -p /etc/kolla
sudo chown $USER:$USER /etc/kolla

# cp 所有 kolla-ansible 文件到 /etc/kolla 中
cp -r kolla-ansible/etc/kolla/* /etc/kolla

# 生成 kolla image 相关配置文件 etc/kolla/kolla-build.conf
# cp  etc/kolla/kolla-build.conf 到 /etc/kolla 目录下
pip install tox
cd kolla/
tox -e genconfig
cp etc/kolla/kolla-build.conf /etc/kolla/kolla-build.conf

# cp kolla-ansible inventory 文件到个人的 work directory
cp kolla-ansible/ansible/inventory/* .
```

## F5 images 制作

### 修改 [/etc/kolla/kolla-build.conf](https://gist.github.com/zhang-shengping/757c5933ba5b08b3be648c2fee5d3448#file-kolla-build-ini) 文件

```ini
[DEFAULT]
# centos image base
base = centos
# 这里使用 rocky 版本 Docker images
tag = rocky
install_type = source

# 创建 neutron-server image 时使用：
# neutron-server 添加 F5 driver, 从 github 上 clone 指定 branch 为 stable/rocky。
[neutron-server-plugin-neutron-lbaas]
type = git
location = https://github.com/F5Networks/f5-openstack-lbaasv2-driver.git
reference = stable/rocky

# 创建 F5 agent image 时使用：
# 指定 neutron-lbaas image 安装 F5 agent 代码。
[neutron-lbaas-agent]
type = git
location = https://github.com/F5Networks/f5-openstack-agent.git
reference = 9.8-stable
```

### F5 server 镜像制作

```bash
# 到 kolla 目录下
cd kolla
# 运行
python tools/build.py neutron-server
```

### F5 agent 镜像制作

制作 `F5 agent` 镜像需要在额外在修改一些文件：

1. 添加 [**`lbaas-overrides.j2`**](https://gist.github.com/zhang-shengping/757c5933ba5b08b3be648c2fee5d3448#file-lbaas-overrides-jinja2) 文件

   ```jinja2
   {% extends parent_template %}

   # Neutron lbaas does not use haproxy, so I do not install haproxy
   {% set neutron_lbaas_agent_packages_remove = ['haproxy'] %}
   ```

2. 修改 **`neutron-lbaas-agent.json.j2`** 文件

   ```bash
   # 注意：可能有多个同名文件，需要找到被 code 使用的 neutron-lbaas-agent.json.j2 文件。
   (rocky-venv) [root@centos7-min kolla]#  find / -name neutron-lbaas-agent.json.j2
   /etc/kolla/config/neutron-lbaas-agent/neutron-lbaas-agent.json.j2
   /root/kolla-ansible/ansible/roles/neutron/templates/neutron-lbaas-agent.json.j2
   /root/rocky-venv/share/kolla-ansible/ansible/roles/neutron/templates/neutron-lbaas-agent.json.j2

   # 在我的环境中，因为是用 virtualenv rocky-venv，所以我要修改
   /root/rocky-venv/share/kolla-ansible/ansible/roles/neutron/templates/neutron-lbaas-agent.json.j2
   ```

   找到正确的 [**`neutron-lbaas-agent.json.j2`**](https://gist.github.com/zhang-shengping/757c5933ba5b08b3be648c2fee5d3448#file-neutron-lbaas-agent-json) 文件，修改如下：

    ```json
   {
       "command": "f5-oslbaasv2-agent --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/services/f5/f5-openstack-agent_bigip.ini",
       "config_files": [
           {
               "source": "{{ container_config_directory }}/neutron.conf",
               "dest": "/etc/neutron/neutron.conf",
               "owner": "neutron",
               "perm": "0600"
           },
           {
               "source": "{{ container_config_directory }}/neutron_lbaas.conf",
               "dest": "/etc/neutron/neutron_lbaas.conf",
               "owner": "neutron",
               "perm": "0600"
           },
           {
               "source": "{{ container_config_directory }}/services/f5/esd/demo.json",
               "dest": "/etc/neutron/services/f5/esd/demo.json",
               "owner": "neutron",
               "perm": "0600",
               "optional": true
           },
           {
               "source": "{{ container_config_directory }}/services/f5/f5-openstack-agent_bigip.ini",
               "dest": "/etc/neutron/services/f5/f5-openstack-agent_bigip14.ini",
               "owner": "neutron",
               "perm": "0600",
               "optional": true
           }
       ],
       "permissions": [
           {
               "path": "/var/log/kolla/neutron",
               "owner": "neutron:neutron",
               "recurse": true
           },
           {
               "path": "/var/lib/neutron/kolla",
               "owner": "neutron:neutron",
               "recurse": true
           }
       ]
   }
    ```

3.  修改 `neutron-lbaas-agent` 的 [**`Dockerfile.j2`** ](https://gist.github.com/zhang-shengping/757c5933ba5b08b3be648c2fee5d3448#file-dockerfile-jinja2) ，如下：

   ```jinja2
   FROM {{ namespace }}/{{ image_prefix }}neutron-base:{{ tag }}
   LABEL maintainer="{{ maintainer }}" name="{{ image_name }}" build-date="{{ build_date }}"

   {% block neutron_lbaas_agent_header %}{% endblock %}

   {% import "macros.j2" as macros with context %}

   {% set neutron_lbaas_agent_packages = [
       'haproxy'
   ] %}
   {{ macros.install_packages(neutron_lbaas_agent_packages | customizable("packages")) }}

   {% if install_type == 'binary' %}
       {% if base_distro in ['centos', 'oraclelinux', 'rhel'] %}

           {% set neutron_lbaas_agent_packages = [
               'openstack-neutron-lbaas'
           ] %}

       {% elif base_distro in ['debian', 'ubuntu'] %}

           {% set neutron_lbaas_agent_packages = [
               'neutron-lbaas-common',
               'neutron-lbaasv2-agent',
               'python-neutron-lbaas'
           ] %}

       {% endif %}

   {{ macros.install_packages(neutron_lbaas_agent_packages | customizable("packages")) }}

   {% elif install_type == 'source' %}

   ADD neutron-lbaas-agent-archive /neutron-lbaas-agent-source

   {% set neutron_lbaas_agent_pip_packages = [
       '/neutron_lbaas'
   ] %}

   RUN ln -s neutron-lbaas-agent-source/* neutron_lbaas \
       && {{ macros.install_pip(neutron_lbaas_agent_pip_packages | customizable("pip_packages")) }} \
       && cp -R /neutron_lbaas/etc/neutron/services /etc/neutron/

   {% endif %}

   COPY extend_start.sh /usr/local/bin/kolla_neutron_extend_start
   RUN chmod 755 /usr/local/bin/kolla_neutron_extend_start

   {% block neutron_lbaas_agent_footer %}{% endblock %}
   {% block footer %}{% endblock %}

   USER neutron
   ```

运行制作镜像命令

```bash
# 到 kolla 目录下
cd kolla
# 运行
python tools/build.py --template-override docker/neutron/neutron-lbaas-agent/lbaas-overrides.j2 neutron-lbaas-agent
```

### 检查镜像

```bash
(rocky-venv) [root@centos7-min ~]# docker images
REPOSITORY                                      TAG                 IMAGE ID            CREATED             SIZE
kolla/centos-source-neutron-lbaas-agent         rocky               97a170877443        46 hours ago        1.15GB
kolla/centos-source-neutron-base                rocky               bf75edc7dfd4        46 hours ago        1.14GB
kolla/centos-source-neutron-server-ovn          rocky               be4826df1354        46 hours ago        1.19GB
kolla/centos-source-neutron-server              rocky               f9730fba9796        46 hours ago        1.16GB
kolla/centos-source-openstack-base              rocky               4f79f2d8a48d        46 hours ago        874MB
kolla/centos-source-base                        rocky               7af6ec23c45f        46 hours ago        424MB
```

`kolla/centos-source-neutron-lbaas-agent:rocky` 和 `kolla/centos-source-neutron-server:rocky` 镜像成功创建。

## F5 Kolla-ansible 部署

### 配置 inventory 文件

这里使用的是 `all-in-one` 的部署方式，Ansible inventory [`all-in-one`](https://gist.github.com/zhang-shengping/757c5933ba5b08b3be648c2fee5d3448#file-all-in-one-ini) 修改如下：

```ini
# These initial groups are the only groups required to be modified. The
# additional groups are for more control of the environment.
[control]
10.145.71.245 ansible_user=root ansible_password=default ansible_become=true

[network]
10.145.71.245 ansible_user=root ansible_password=default ansible_become=true

# inner-compute is the groups of compute nodes which do not have
# external reachability.
# DEPRECATED, the group will be removed in S release of OpenStack,
# use variable neutron_compute_dvr_mode instead.
[inner-compute]

# external-compute is the groups of compute nodes which can reach
# outside.
# DEPRECATED, the group will be removed in S release of OpenStack,
# use variable neutron_compute_dvr_mode instead.
[external-compute]
10.145.71.245 ansible_user=root ansible_password=default ansible_become=true

[compute:children]
inner-compute
external-compute

[storage]
10.145.71.245 ansible_user=root ansible_password=default ansible_become=true

[monitoring]
10.145.71.245 ansible_user=root ansible_password=default ansible_become=true

[deployment]
10.145.71.245 ansible_user=root ansible_password=default ansible_become=true
```

### 创建自定义配置目录和配置

创建自定义目录：

```bash
# 创建 kolla 自定义配置目录
mkdir /etc/kolla/config

# 创建 neutron 自定义配置目录
mkdir /etc/koll/config/neutron

# 创建 neutron lbaasv2 自定义配置目录
mkdir /etc/kolla/config/neutron-lbaas-agent
```

创建自定义配置：

1. 将 `neutron_lbaas` 的 `service_provider` 配置改写存放在 `/etc/kolla/config/neutron` 目录下，改写如下：

   ```ini
   [service_providers]
   service_provider = LOADBALANCERV2:F5Networks:neutron_lbaas.drivers.f5.driver_v2.F5LBaaSV2Driver:default
   ```

### F5 agent 配置

1. 根据环境配置 f5 agent 的 `services/f5/f5-openstack-agent_bigip.ini` 和 `/services/f5/esd/demo.json` 文件。
2. 将整个配置完成的 `services`文件夹 copy 到 `/etc/kolla/neutron-lbaas-agent`目录下。如果目录不存在，那么可以先进行下一步 [部署 all-in-one Openstack](#部署 all-in-one Openstack) 后，再 copy 过去。

执行上面步骤的原因是 kolla-ansible 中没有对 F5 agent 配置和文件处理相关的代码，必须手动将配置文件复制到对应的目录。

启动 neutron-lbaas-agent 的 container 后 `/etc/kolla/neutron-lbaas-agent` 目录中的文件会被挂载到contianer 的 `/var/lib/kolla/config_files` 目录。container 启动时使用 `dumb-init` 执行 `set_config.py` (来自 base image) 命令去读取  [**`neutron-lbaas-agent.json.j2`**](https://gist.github.com/zhang-shengping/757c5933ba5b08b3be648c2fee5d3448#file-neutron-lbaas-agent-json)  文件进行配置。

在 set_config.py 配置过程中，必须保证  [**`neutron-lbaas-agent.json.j2`**](https://gist.github.com/zhang-shengping/757c5933ba5b08b3be648c2fee5d3448#file-neutron-lbaas-agent-json)  中所有文件都存在对应的目录下。

### 部署 all-in-one Openstack

部署 Openstack 需要运行如下命令，前两条命了 check 主机状态，最后一条部署 Openstack。

```bash
kolla-ansible -i all-in-one bootstrap-servers
kolla-ansible -i all-in-one prechecks
kolla-ansible -i all-in-one deploy
```

部署完以后，我们会看到

```bash
(rocky-venv) [root@centos7-min ~]# docker ps
CONTAINER ID        IMAGE                                                 COMMAND                  CREATED             STATUS              PORTS               NAMES
35e0684bf634        kolla/centos-source-horizon:rocky                     "dumb-init --single-…"   41 hours ago        Up 41 hours                             horizon
dfb7474f2125        kolla/centos-source-neutron-metadata-agent:rocky      "dumb-init --single-…"   41 hours ago        Up 41 hours                             neutron_metadata_agent
541a0de75b9b        kolla/centos-source-neutron-lbaas-agent:rocky         "dumb-init --single-…"   41 hours ago        Up 28 hours                             neutron_lbaas_agent
ca8f519c82d4        kolla/centos-source-neutron-l3-agent:rocky            "dumb-init --single-…"   41 hours ago        Up 41 hours                             neutron_l3_agent
3f5917414e49        kolla/centos-source-neutron-dhcp-agent:rocky          "dumb-init --single-…"   41 hours ago        Up 41 hours                             neutron_dhcp_agent
6c80152ab9d6        kolla/centos-source-neutron-openvswitch-agent:rocky   "dumb-init --single-…"   41 hours ago        Up 41 hours                             neutron_openvswitch_agent
6872b3619acc        kolla/centos-source-neutron-server:rocky              "dumb-init --single-…"   41 hours ago        Up 41 hours                             neutron_server
2795b31614d5        kolla/centos-source-openvswitch-vswitchd:rocky        "dumb-init --single-…"   41 hours ago        Up 41 hours                             openvswitch_vswitchd
f1862b47421b        kolla/centos-source-openvswitch-db-server:rocky       "dumb-init --single-…"   41 hours ago        Up 41 hours                             openvswitch_db
68b04a5eba75        kolla/centos-source-nova-compute:rocky                "dumb-init --single-…"   41 hours ago        Up 41 hours                             nova_compute
74da99dd1035        kolla/centos-source-nova-novncproxy:rocky             "dumb-init --single-…"   41 hours ago        Up 41 hours                             nova_novncproxy
374936a21c72        kolla/centos-source-nova-consoleauth:rocky            "dumb-init --single-…"   41 hours ago        Up 41 hours                             nova_consoleauth
97ae7866f849        kolla/centos-source-nova-conductor:rocky              "dumb-init --single-…"   41 hours ago        Up 41 hours                             nova_conductor
247964a529fc        kolla/centos-source-nova-scheduler:rocky              "dumb-init --single-…"   41 hours ago        Up 41 hours                             nova_scheduler
d45a4faf0f89        kolla/centos-source-nova-api:rocky                    "dumb-init --single-…"   41 hours ago        Up 41 hours                             nova_api
42a310689d0c        kolla/centos-source-nova-placement-api:rocky          "dumb-init --single-…"   41 hours ago        Up 41 hours                             placement_api
87194212c3b7        kolla/centos-source-nova-libvirt:rocky                "dumb-init --single-…"   41 hours ago        Up 41 hours                             nova_libvirt
e93868f32fa7        kolla/centos-source-glance-api:rocky                  "dumb-init --single-…"   41 hours ago        Up 41 hours                             glance_api
172686d346e2        kolla/centos-source-keystone-fernet:rocky             "dumb-init --single-…"   42 hours ago        Up 42 hours                             keystone_fernet
9cb661bbac17        kolla/centos-source-keystone-ssh:rocky                "dumb-init --single-…"   42 hours ago        Up 42 hours                             keystone_ssh
00efb0d8450c        kolla/centos-source-keystone:rocky                    "dumb-init --single-…"   42 hours ago        Up 42 hours                             keystone
fff928dcdfd5        kolla/centos-source-rabbitmq:rocky                    "dumb-init --single-…"   42 hours ago        Up 42 hours                             rabbitmq
46d2ec1aeb34        kolla/centos-source-mariadb:rocky                     "dumb-init -- kolla_…"   42 hours ago        Up 42 hours                             mariadb
4beda09ddf1a        kolla/centos-source-memcached:rocky                   "dumb-init --single-…"   42 hours ago        Up 42 hours                             memcached
e9e14bc5b3af        kolla/centos-source-chrony:rocky                      "dumb-init --single-…"   42 hours ago        Up 42 hours                             chrony
0a0bccaf2b46        kolla/centos-source-cron:rocky                        "dumb-init --single-…"   42 hours ago        Up 42 hours                             cron
97711b974d4a        kolla/centos-source-kolla-toolbox:rocky               "dumb-init --single-…"   42 hours ago        Up 42 hours                             kolla_toolbox
b5dfd4e22d8e        kolla/centos-source-fluentd:rocky                     "dumb-init --single-…"   42 hours ago        Up 42 hours                             fluentd
```
